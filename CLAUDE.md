# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Blokada 6 is a cross-platform mobile ad blocker and privacy app with cloud-based blocking capabilities. The codebase supports:
- Android apps (Blokada 6 and Blokada Family)
- iOS apps (Blokada 6 and Blokada Family)
- Flutter-based UI with platform-specific native code
- WireGuard VPN integration

## Architecture

### Project Structure
- `common/` - Shared Flutter module containing UI and business logic
  - `lib/common.dart` - Public package surface (entrypoints and shared types)
  - `lib/src/core/` - Core utilities, dependency injection, persistence
  - `lib/src/features/` - Feature-first modules (`<feature>/{domain,ui}`), including tiered features like `plus`
  - `lib/src/app_variants/` - Variant-specific overrides (`v6`, `family`)
  - `lib/src/shared/` - Shared UI, navigation, automation ids
  - `lib/src/platform/` - Platform channel interfaces (generated by Pigeon)
  - `lib/src/util/` - Shared utilities
- `android/` - Android native app with Gradle build
- `ios/` - iOS native app with Xcode project
- `scripts/` - Build and utility scripts
- `metadata/` - App store metadata for all platforms

### Key Technologies
- Flutter for cross-platform UI
- Kotlin for Android native code
- Swift for iOS native code
- Pigeon for type-safe platform channels
- MobX for state management
- WireGuard for VPN functionality

## Development Commands

### Prerequisites
Before building, ensure dependencies are initialized:
```bash
git submodule update --init --recursive
```

### Development Workflow

**Iterative development process:**
1. **Make code changes**
2. **Regenerate interfaces** (if modified `libgen/*.dart`): `make regen-ios` (iOS only) or `make regen` (all platforms)  
3. **Check linting**: `fvm flutter analyze` - fix syntax/style issues immediately
4. **Ensure tests pass**: `make test` - iterate steps 1-4 until **ALL** tests pass
5. **Test on device**: Manual verification on physical device

### Device Testing (Step 5 of Workflow)

```bash
# iOS: Build, install and run with console output
make -C ios run-six      # or make -C ios run-family
make -C ios run-six DEVICE_NAME="Your Device"  # specify device

# Android: Install debug builds
make install-family-debug    # or make install-six-debug
```

### Building

#### Debug Builds (for development)
```bash
# Android
make build-android-family-debug
make build-android-six-debug
make build-android-family-debug-quick  # if common lib unchanged
make build-android-six-debug-quick

# iOS  
make build-ios-six-debug
# Note: make -C ios run automatically builds, installs, and runs
```

#### Release Builds (for deployment)
```bash
# Android
make build-android
make build-android-family
make build-android-six

# iOS
make build-ios
make build-ios-family
make build-ios-six
```

### Testing & Linting (Steps 3-4 of Workflow)

```bash
# Run all tests
make test

# Check linting
fvm flutter analyze

# Direct Flutter commands (if needed)
cd common && fvm flutter test
cd common && fvm flutter analyze
```

### Code Generation
```bash
# Generate all platform interfaces and mocks
make regen

# Generate just the platform interfaces
make gen

# Clean and regenerate for Android
make regen-android

# Clean and regenerate for iOS
make regen-ios
```

### Installing on Device
```bash
# Install Family app
make install-family        # release
make install-family-debug  # debug

# Install Blokada 6 app
make install-six          # release
make install-six-debug    # debug

# Uninstall all
make uninstall
```

### Device Testing & Debugging
```bash
# iOS: Build, install and run with console output (BLOCKING - use background task)
make -C ios run-six [DEVICE_NAME="device name"] [CONFIG="Release|Debug"]
make -C ios run-family [DEVICE_NAME="device name"] [CONFIG="Release|Debug"]
# Default: CONFIG=Release (required for iOS 14+ to launch without Xcode/Flutter tooling)
# These commands are blocking and provide console output - run as background task when needed

# Android: Install and run debug builds
make install-family-debug    # or make install-six-debug
```

### Version Management
```bash
# Set version (use NAME and CODE params)
make version NAME=6.24.0 CODE=624000

# Or use environment variables
export BLOKADA_VERSION_NAME=6.24.0
export BLOKADA_VERSION_CODE=624000
make version
```

## Platform-Specific Development

### Flutter Module
The `common/` directory is a Flutter module that gets embedded into native apps:
- Run `flutter pub get` to fetch dependencies
- Use `flutter build aar` for Android library
- iOS framework is built automatically by Xcode

### Android
- Uses Gradle for building
- Product flavors: `family` and `six`
- Build types: `debug` and `release`
- Run individual Gradle tasks with `./gradlew` in `android/` directory

### iOS
- Uses Xcode workspace (`IOS.xcworkspace`)
- Schemes: `FamilyProd`, `FamilyDev`, `Prod`, `Dev`, `Mocked`
- Fastlane for automation and deployment
- CocoaPods for dependency management
- **iOS 14+ Flutter Debug Limitation**: Flutter debug mode apps cannot launch directly on device without Xcode/Flutter tooling connection. The `make -C ios run` target defaults to Release mode to bypass this restriction.

#### Mac Support ("Designed for iPad")
iOS apps can run on Mac with Apple Silicon. If you get provisioning profile errors when selecting Mac as target:

1. **Register Mac device** (requires OTP - must be run manually):
```bash
cd ios
fastlane run register_device name:"Mac Name" udid:"$(system_profiler SPHardwareDataType | grep 'Provisioning UDID' | awk '{print $3}')" team_id:"HQH5AFGB68"
```

2. **Regenerate profiles with Mac support**:
```bash
make fastlane-match
```

## Important Considerations

1. **Platform Channels**: Communication between Flutter and native code uses Pigeon-generated interfaces. Always regenerate after modifying `.dart` files in `libgen/`

2. **Two App Variants**: The codebase builds two distinct apps:
   - Blokada 6: Full VPN and cloud-based blocking
   - Blokada Family: Simplified family protection

3. **Subscription Model**: Both apps require subscriptions and use Adapty for payment processing

4. **Localization**: Translations are in `common/assets/translations/` and synced using `make translate`

5. **CI/CD**: The project uses GitHub Actions for CI. See `make ci-*` targets for CI-specific builds

## Business logic

For detailed information about bussiness logic such as account types, subscription states, and feature access, see:

@common/docs/ACCOUNT_TYPES.md and other relevant documents in the `common/docs/` directory.
