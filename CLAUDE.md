# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Blokada 6 is a cross-platform mobile ad blocker and privacy app with cloud-based blocking capabilities. The codebase supports:
- Android apps (Blokada 6 and Blokada Family)
- iOS apps (Blokada 6 and Blokada Family)
- Flutter-based UI with platform-specific native code
- WireGuard VPN integration

## Architecture

### Project Structure
- `common/` - Shared Flutter module containing UI and business logic
  - `lib/core/` - Core utilities, dependency injection, persistence
  - `lib/common/` - Common modules (account, filters, payments, etc.)
  - `lib/family/` - Family app specific code
  - `lib/v6/` - Blokada 6 specific code
  - `lib/platform/` - Platform channel interfaces (generated by Pigeon)
- `android/` - Android native app with Gradle build
- `ios/` - iOS native app with Xcode project
- `scripts/` - Build and utility scripts
- `metadata/` - App store metadata for all platforms

### Key Technologies
- Flutter for cross-platform UI
- Kotlin for Android native code
- Swift for iOS native code
- Pigeon for type-safe platform channels
- MobX for state management
- WireGuard for VPN functionality

## Development Commands

### Prerequisites
Before building, ensure dependencies are initialized:
```bash
git submodule update --init --recursive
```

### Building

#### Android Debug APKs
```bash
# Build Family app (debug)
make build-android-family-debug

# Build Blokada 6 app (debug)
make build-android-six-debug

# Quick rebuild (if common lib unchanged)
make build-android-family-debug-quick
make build-android-six-debug-quick
```

#### Android Release AABs
```bash
# Build all Android apps
make build-android

# Build specific app
make build-android-family
make build-android-six
```

#### iOS
```bash
# Build all iOS apps
make build-ios

# Build specific app
make build-ios-family
make build-ios-six
```

### Testing
```bash
# Run all tests
make test

# Run Flutter tests directly
cd common && flutter test
```

### Linting
```bash
# Run Flutter analyzer
cd common && flutter analyze
```

### Code Generation
```bash
# Generate all platform interfaces and mocks
make regen

# Generate just the platform interfaces
make gen

# Clean and regenerate for Android
make regen-android

# Clean and regenerate for iOS
make regen-ios
```

### Installing on Device
```bash
# Install Family app
make install-family        # release
make install-family-debug  # debug

# Install Blokada 6 app
make install-six          # release
make install-six-debug    # debug

# Uninstall all
make uninstall
```

### Version Management
```bash
# Set version (use NAME and CODE params)
make version NAME=6.24.0 CODE=624000

# Or use environment variables
export BLOKADA_VERSION_NAME=6.24.0
export BLOKADA_VERSION_CODE=624000
make version
```

## Platform-Specific Development

### Flutter Module
The `common/` directory is a Flutter module that gets embedded into native apps:
- Run `flutter pub get` to fetch dependencies
- Use `flutter build aar` for Android library
- iOS framework is built automatically by Xcode

### Android
- Uses Gradle for building
- Product flavors: `family` and `six`
- Build types: `debug` and `release`
- Run individual Gradle tasks with `./gradlew` in `android/` directory

### iOS
- Uses Xcode workspace (`IOS.xcworkspace`)
- Schemes: `FamilyProd`, `FamilyDev`, `Prod`, `Dev`, `Mocked`
- Fastlane for automation and deployment
- CocoaPods for dependency management

## Important Considerations

1. **Platform Channels**: Communication between Flutter and native code uses Pigeon-generated interfaces. Always regenerate after modifying `.dart` files in `libgen/`

2. **Two App Variants**: The codebase builds two distinct apps:
   - Blokada 6: Full VPN and cloud-based blocking
   - Blokada Family: Simplified family protection

3. **Subscription Model**: Both apps require subscriptions and use Adapty for payment processing

4. **Localization**: Translations are in `common/assets/translations/` and synced using `make translate`

5. **CI/CD**: The project uses GitHub Actions for CI. See `make ci-*` targets for CI-specific builds

## Business logic

For detailed information about bussiness logic such as account types, subscription states, and feature access, see:

@common/docs/ACCOUNT_TYPES.md and other relevant documents in the `common/docs/` directory.
