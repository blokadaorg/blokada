version: 38
jobs:
- name: build-android-family
  steps:
  - !CheckoutStep
    name: checkout
    cloneCredential: !DefaultCredential {}
    withLfs: false
    withSubmodules: false
    condition: ALL_PREVIOUS_STEPS_WERE_SUCCESSFUL
  - !RunContainerStep
    name: docker buildbox build aab
    image: docker-apps-build-box
    args: make ci-build-android-family
    envVars:
    - name: GRADLE_OPTS
      value: -Dorg.gradle.unsafe.disable.watch-fs=true -Dorg.gradle.vfs.watch=false
    - name: BLOKADA_KEY_PWD
      value: '@secret:BLOKADA_KEY_PWD@'
    - name: BLOKADA_KEYSTORE_PWD
      value: '@secret:BLOKADA_KEYSTORE_PWD@'
    - name: BLOKADA_KEYSTORE_BASE64
      value: '@secret:BLOKADA_KEYSTORE_BASE64@'
    useTTY: true
    condition: ALL_PREVIOUS_STEPS_WERE_SUCCESSFUL
  - !PublishArtifactStep
    name: publish artifacts
    artifacts: android/app/build/outputs/bundle/**
    condition: ALL_PREVIOUS_STEPS_WERE_SUCCESSFUL
  retryCondition: never
  maxRetries: 3
  retryDelay: 30
  timeout: 14400
- name: publish-android-family
  steps:
  - !CheckoutStep
    name: checkout
    cloneCredential: !DefaultCredential {}
    withLfs: false
    withSubmodules: false
    condition: ALL_PREVIOUS_STEPS_WERE_SUCCESSFUL
  - !RunContainerStep
    name: docker buildbox publish
    image: docker-apps-build-box
    args: make publish-android
    envVars:
    - name: BLOKADA_GPLAY_KEY_BASE64
      value: '@secret:BLOKADA_GPLAY_KEY_BASE64@'
    useTTY: true
    condition: ALL_PREVIOUS_STEPS_WERE_SUCCESSFUL
  jobDependencies:
  - jobName: build-android-family
    requireSuccessful: true
    artifacts: '**'
  retryCondition: never
  maxRetries: 3
  retryDelay: 30
  timeout: 14400
